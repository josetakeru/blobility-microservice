version: 2.1

jobs:
  maven-build-and-docker-build-push:
    machine: true
    steps:
      - checkout
      - run: |
          if [[ $(git log -1 --pretty=%B) == "CICD pipeline: Update app version" ]]; then circleci-agent step halt; fi
      - run:
          name: Install OpenJDK 11
          command: |
            sudo apt-get update && sudo apt-get install openjdk-11-jdk
            sudo update-alternatives --set java /usr/lib/jvm/java-11-openjdk-amd64/bin/java
            sudo update-alternatives --set javac /usr/lib/jvm/java-11-openjdk-amd64/bin/javac
            java -version
      - run:
          name: Maven build & tests
          command: |
            mvn -B -DskipTests clean package
            mvn test
      - run:
          name: "Docker build and push"
          command: |
            set -x
            APP_NAME=$(grep -A1 "<!-- DO NOT REMOVE THIS AUTOMATION MESSAGE - APP NAME -->" pom.xml | tail -1 | sed -e "s/<name>\(.*\)<\/name>/\1/")
            export APP_NAME=$(echo ${APP_NAME//[[:blank:]]/})
            APP_VERSION=$(grep -A1 "<!-- DO NOT REMOVE THIS AUTOMATION MESSAGE - APP VERSION -->" pom.xml | tail -1 | sed -e "s/<version>\(.*\)<\/version>/\1/")
            export APP_VERSION=$(echo ${APP_VERSION//[[:blank:]]/})
            docker build -t $DOCKER_HUB_USER/$APP_NAME:$APP_VERSION .
            docker login -u $DOCKER_HUB_USER -p $DOCKER_HUB_PASSWORD
            docker push $DOCKER_HUB_USER/$APP_NAME:$APP_VERSION
  update-app-version:
    machine: true
    steps:
      - checkout
      - run:
          name: "Set Github credentials"
          command: |
            TMP_DIR=$(mktemp -d)
            git config --global user.email "23168163+josetakeru@users.noreply.github.com"
            git config --global user.name "Jos√© Takeru"
            git clone https://$GITHUB_TOKEN@github.com/josetakeru/tier-blobility-microservice.git ${TMP_DIR}
            cd ${TMP_DIR}
            APP_VERSION=$(grep -A1 "<!-- DO NOT REMOVE THIS AUTOMATION MESSAGE - APP VERSION -->" pom.xml | tail -1 | sed -e "s/<version>\(.*\)<\/version>/\1/")
            LINE_NUMBER=$(APP_VERSION=$(grep -A1 "<!-- DO NOT REMOVE THIS AUTOMATION MESSAGE - APP VERSION -->" pom.xml | tail -1 | sed -e "s/<version>\(.*\)<\/version>/\1/") | awk -F: '{print $1}')
            MINOR_VERSION=$(echo "${APP_VERSION##*.}")
            NEW_MINOR_VERSION=$((${MINOR_VERSION} + 1))
            NEW_APP_VERSION="${APP_VERSION%.*}.${NEW_MINOR_VERSION}"
            printf '>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>'
            echo "App version will be updated to ${NEW_APP_VERSION}"
            printf '>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>'
            sed "${LINE_NUMBER}s/.*/app_version=${NEW_APP_VERSION}/" pom.xml > pom_tmp.xml
            mv pom_tmp.xml pom.xml  
            git add pom.xml
            git commit -m "CICD pipeline: Update app version"
            git push origin master

workflows:
  set-environment-variables:
    jobs:
      - maven-build-and-docker-build-push
      - update-app-version:
          requires:
            - maven-build-and-docker-build-push
